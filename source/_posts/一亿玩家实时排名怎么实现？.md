---
title: ä¸€äº¿ç©å®¶å®æ—¶æ’åæ€ä¹ˆå®ç°ï¼Ÿ
tags: [Java,Redisson]
categories: Java
date: 2026-02-06 14:38:53
---



## å‰è¨€

é¢è¯•ä¸­è¢«é—®åˆ° â€œ1 äº¿ç©å®¶å®æ—¶æ’åå¦‚ä½•å®ç°â€ï¼Œ90% çš„å¼€å‘è€…åªä¼šè¯´ â€œç”¨ Redisâ€ï¼Œä½†èƒ½è®²æ¸…**åˆ†ç‰‡ç­–ç•¥ã€åŒåˆ†æ•°æ’åºã€æ€§èƒ½ä¼˜åŒ–** çš„äººä¸è¶³ 10%ã€‚

è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒè¯‰æ±‚è¿œä¸æ­¢ â€œèƒ½ç”¨ Redisâ€ï¼Œè€Œæ˜¯è¦æ»¡è¶³ï¼š

- **æ’åæ¯«ç§’çº§å®æ—¶æ›´æ–°**ï¼ˆç©å®¶åˆ†æ•°å˜åŒ–ç«‹å³åæ˜ ï¼‰ï¼›
- **é«˜å¹¶å‘æŸ¥è¯¢**ï¼ˆç™¾ä¸‡ QPS ä¸‹æ’åæŸ¥è¯¢ä¸å¡é¡¿ï¼‰ï¼›
- **æµ·é‡æ•°æ®æ”¯æ’‘**ï¼ˆ1 äº¿ç©å®¶æ— æ€§èƒ½ç“¶é¢ˆï¼‰ï¼›
- **è¾¹ç•Œåœºæ™¯å…¼å®¹**ï¼ˆåŒåˆ†æ•°ã€è·¨åˆ†ç‰‡å…¨å±€æ’åï¼‰ã€‚

åœ¨æ¸¸æˆã€ç›´æ’­ç­‰äº’è”ç½‘åœºæ™¯ä¸­ï¼Œå®æ—¶æ’åç³»ç»Ÿæ˜¯æå‡ç”¨æˆ·å‚ä¸æ„Ÿå’Œåˆºæ¿€ç«äº‰çš„æ ¸å¿ƒåŠŸèƒ½ã€‚æœ¬æ–‡å°†ä»é›¶å¼€å§‹ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæ”¯æŒ1äº¿ç©å®¶ã€é«˜å¹¶å‘å®æ—¶æ›´æ–°çš„æ’åç³»ç»Ÿã€‚

<!--more-->



#### æ ¸å¿ƒå®ç°æ€è·¯ï¼šä¸ºä»€ä¹ˆé€‰ Redis ZSetï¼Ÿ

ä¼ ç»Ÿ MySQL å®ç°æ’åçš„ç—›ç‚¹ï¼š

- æ’åºæ“ä½œï¼ˆORDER BYï¼‰æ—¶é—´å¤æ‚åº¦ O (n log n)ï¼Œ1 äº¿æ•°æ®ç›´æ¥å¡æ­»ï¼›
- åˆ†æ•°æ›´æ–°éœ€è¦è¡Œé”/è¡¨é”ï¼Œå¹¶å‘æ€§èƒ½æå·®ï¼›
- æ— æ³•æ”¯æ’‘é«˜é¢‘æ¬¡çš„æ’åæŸ¥è¯¢ã€‚



è€Œ Redis ZSetï¼ˆæœ‰åºé›†åˆï¼‰æ˜¯æœ€ä¼˜è§£ï¼Œæ ¸å¿ƒä¼˜åŠ¿ï¼š

- **æ€§èƒ½æè‡´**ï¼šåº•å±‚åŸºäºã€Œè·³è¡¨ + å“ˆå¸Œè¡¨ã€ï¼Œå¢ / åˆ  / æ”¹ / æŸ¥æ’åçš„æ—¶é—´å¤æ‚åº¦å‡ä¸º O (log N)ï¼Œ1 äº¿æ•°æ®çš„ logâ‚‚(1e8)â‰ˆ27ï¼Œæ¯«ç§’çº§å“åº”ï¼›
- **å¤©ç„¶æœ‰åº**ï¼šè‡ªåŠ¨æŒ‰åˆ†æ•°æ’åºï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼›
- **åŸå­æ“ä½œ**ï¼šZINCRBYã€ZADD ç­‰å‘½ä»¤å¤©ç„¶åŸå­æ€§ï¼Œé¿å…å¹¶å‘é—®é¢˜ã€‚



ä½†å• ZSet æ— æ³•æ‰¿è½½ 1 äº¿æ•°æ®ï¼Œéœ€è¡¥å…… 3 ä¸ªå…³é”®ç­–ç•¥ï¼š

- **åˆ†ç‰‡ç­–ç•¥**ï¼šæŒ‰ç©å®¶ ID å“ˆå¸Œæ‹†åˆ†åˆ°å¤šä¸ª ZSetï¼ˆå¦‚ 100 ä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ª 1000 ä¸‡æ•°æ®ï¼‰ï¼Œè§„é¿å• Key æ€§èƒ½ç“¶é¢ˆï¼›
- **åˆ†æ•°é‡æ„**ï¼šè§£å†³åŒåˆ†æ•°æ’åºé—®é¢˜ï¼ˆå¦‚ â€œå…ˆåˆ°é’»çŸ³æ®µä½çš„ç©å®¶æ’åé å‰â€ï¼‰ï¼›
- **é«˜å¯ç”¨ä¿éšœ**ï¼šRedis é›†ç¾¤ï¼ˆä¸»ä» + å“¨å…µï¼‰+ å¼‚æ­¥æŒä¹…åŒ–åˆ° MySQL å…œåº•ï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚




## ä¸€ã€Redis ZSet åŸºç¡€

å…ˆç§‘æ™®ä¸€ä¸‹zsetï¼ŒRedis çš„æœ‰åºé›†åˆï¼ˆSorted Setï¼Œç®€ç§° ZSetï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”ç‹¬ç‰¹çš„æ•°æ®ç»“æ„ã€‚å®ƒçš„æ¯ä¸ªå…ƒç´ éƒ½ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

- **æˆå‘˜ (Member)**ï¼šå°±åƒæ’è¡Œæ¦œä¸Šçš„åå­—ï¼Œæ¯”å¦‚ç©å®¶çš„IDã€å•†å“çš„ç¼–å·ï¼Œå®ƒåœ¨é›†åˆä¸­æ˜¯**å”¯ä¸€**çš„ï¼Œä¸èƒ½é‡å¤ã€‚

- **åˆ†æ•° (Score)**ï¼šä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä»£è¡¨æˆå‘˜çš„â€œæƒé‡â€æˆ–â€œåˆ†å€¼â€ï¼Œæ¯”å¦‚ç©å®¶çš„å¾—åˆ†ã€å•†å“çš„é”€é‡ã€‚åˆ†æ•°æ˜¯æ’åºçš„ä¾æ®ï¼Œ**å¯ä»¥é‡å¤**ã€‚

ZSet æœ€æ ¸å¿ƒçš„ç‰¹æ€§æ˜¯ï¼Œå®ƒä¼š**è‡ªåŠ¨æ ¹æ®åˆ†æ•°å¯¹æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åº**ã€‚å¦‚æœå¤šä¸ªæˆå‘˜åˆ†æ•°ç›¸åŒï¼Œåˆ™å†æŒ‰æˆå‘˜è‡ªèº«çš„å­—å…¸é¡ºåºæ’åº ã€‚å®ƒæ—¢ä¿æŒäº†é›†åˆï¼ˆSetï¼‰æˆå‘˜å”¯ä¸€çš„ç‰¹æ€§ï¼Œåˆåƒåˆ—è¡¨ï¼ˆListï¼‰ä¸€æ ·æœ‰åºï¼Œä½†æ’åºè§„åˆ™ä¸æ˜¯æ’å…¥é¡ºåºï¼Œè€Œæ˜¯åˆ†æ•°ã€‚



**é«˜é¢‘å‘½ä»¤é€ŸæŸ¥ï¼ˆå®æˆ˜å¸¸ç”¨ï¼‰å‘½ä»¤ç¤ºä¾‹**ï¼š


```bash
# æ·»åŠ æ•°æ®ï¼Œå¼ ä¸‰ï¼ˆ100åˆ†ï¼‰ã€æå››ï¼ˆ95åˆ†ï¼‰ã€ç‹äº”ï¼ˆ98åˆ†ï¼‰
ZADD player_scores 100 "zhangsan" 95 "lisi" 98 "wangwu"  90 "zhaoliu" 88 "sunqi" 80 "zhouba" 
# æ·»åŠ æ•°æ®
ZADD player_scores 60 "wujiu"


# ç»™æ•´ä¸ª Key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆä¸¤ç§å¸¸ç”¨æ–¹å¼ï¼‰
# æ–¹å¼1ï¼šç›¸å¯¹æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œç¤ºä¾‹ï¼š1å°æ—¶åè¿‡æœŸï¼ˆ3600ç§’ï¼‰
EXPIRE player_scores 3600
# æ–¹å¼2ï¼šç»å¯¹æ—¶é—´ï¼ˆå•ä½ï¼šæ¯«ç§’æ—¶é—´æˆ³ï¼‰
PEXPIREAT player_scores 1770266046000

# ====éªŒè¯è¿‡æœŸæ—¶é—´======
# è¿”å›å‰©ä½™è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ-1=æ°¸ä¸è¿‡æœŸï¼Œ-2=å·²è¿‡æœŸ
TTL player_scores
# è¿”å›å‰©ä½™è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
PTTL player_scores 



# è·å– ç‹äº” åˆ†æ•°
ZSCORE player_scores "wangwu"
# ç»™ç‹äº”å¢åŠ 10æ’åºåˆ†æ•°
ZINCRBY player_scores 10 "wangwu"


# æŒ‰æ’åæŸ¥è¯¢ï¼Œå‡åºï¼Œå‰ä¸‰å
ZRANGE player_scores 0 2 
# æŒ‰æ’åæŸ¥è¯¢ï¼Œå‡åºï¼Œå‰ä¸‰ååŠå…¶ç§¯åˆ†WITHSCORESé€‰é¡¹ä¼šåŒæ—¶è¿”å›ç§¯åˆ†
ZRANGE player_scores 0 2 WITHSCORES
# æŒ‰æ’åæŸ¥è¯¢ï¼Œå‡åº,æ‰€æœ‰äºº
ZRANGE player_scores 0 -1 WITHSCORES

# æŸ¥è¯¢èµµå…­æ’ç¬¬å‡ åï¼Œå‡åºï¼Œç´¢å¼•ä»0å¼€å§‹
ZRANK player_scores "zhaoliu"
# æŸ¥è¯¢èµµå…­æ’ç¬¬å‡ åï¼Œé™åºï¼Œç´¢å¼•ä»0å¼€å§‹
ZREVRANK player_scores "zhaoliu"
# æŒ‰æ’åæŸ¥è¯¢ï¼Œé™åºï¼Œå‰ä¸‰å
ZREVRANGE player_scores 0 2 WITHSCORES

# ========== æŒ‰åˆ†æ•°åŒºé—´ç²¾å‡†æŸ¥è¯¢ ==========
# ZRANGEBYSCOREï¼šæŒ‰åˆ†æ•°å‡åºæŸ¥85-100åˆ†çš„æˆå‘˜ï¼ˆå«è¾¹ç•Œï¼Œè¿”å›æˆå‘˜+åˆ†æ•°ï¼‰
ZRANGEBYSCORE player_scores 85 100 WITHSCORES
# æŸ¥â‰¤100åˆ†çš„æˆå‘˜ï¼ˆ-infè¡¨ç¤ºè´Ÿæ— ç©·ï¼‰
ZRANGEBYSCORE player_scores -inf 100 WITHSCORES
# æŸ¥>90ä¸”â‰¤100åˆ†çš„æˆå‘˜ï¼ˆ( è¡¨ç¤ºå¼€åŒºé—´ï¼Œä¸å«90ï¼‰
ZRANGEBYSCORE player_scores (90 100 WITHSCORES
# ZREVRANGEBYSCOREï¼šæŒ‰åˆ†æ•°é™åºæŸ¥90-110åˆ†çš„æˆå‘˜
ZREVRANGEBYSCORE player_scores 110 90 WITHSCORES


# ========== å¼¹å‡ºå…ƒç´ ï¼ˆç§»é™¤+è¿”å›ï¼‰ ==========
# ZPOPMINï¼šå¼¹å‡ºåˆ†æ•°æœ€å°çš„1ä¸ªæˆå‘˜ï¼ˆå¯æŒ‡å®šæ•°é‡ï¼Œå¦‚ZPOPMIN key 3ï¼‰
ZPOPMIN player_scores
# ZPOPMAXï¼šå¼¹å‡ºåˆ†æ•°æœ€å¤§çš„1ä¸ªæˆå‘˜
ZPOPMAX player_scores

# BZPOPMIN/BZPOPMAXï¼šé˜»å¡å¼å¼¹å‡ºï¼ˆæ— å…ƒç´ æ—¶é˜»å¡ï¼Œè¶…æ—¶å•ä½ç§’ï¼‰
# é˜»å¡5ç§’ï¼Œæ— å…ƒç´ è¿”å›nil
BZPOPMIN player_scores 5
# é˜»å¡10ç§’ï¼Œé€‚ç”¨äºå¼‚æ­¥æ¶ˆè´¹åœºæ™¯
BZPOPMAX player_scores 10


# åˆ é™¤æŒ‡å®šæˆå‘˜
ZREM player_scores "lisi"
# åˆ é™¤å¤šä¸ªæˆå‘˜
ZREM player_scores "lisi" "wangwu"
# æŒ‰ç§¯åˆ†åŒºé—´åˆ é™¤ï¼Œåˆ é™¤ç§¯åˆ†åœ¨0åˆ°50ä¹‹é—´çš„æ‰€æœ‰æˆå‘˜
ZREMRANGEBYSCORE player_scores 0 50
# æŒ‰æ’ååŒºé—´åˆ é™¤ï¼Œåˆ é™¤æ­£åºæ’åä¸­æœ€ä½çš„ä¸‰åç©å®¶
ZREMRANGEBYRANK player_scores 0 2

# æŸ¥è¯¢ç§¯åˆ†åŒºé—´äººæ•°
ZCOUNT player_scores 90 110
# æŸ¥è¯¢æˆå‘˜æ•°é‡
ZCARD player_scores



# ========== å¤šé›†åˆèšåˆè¿ç®— ==========
# å…ˆåˆ›å»ºç¬¬äºŒä¸ªé›†åˆï¼ˆç¤ºä¾‹ï¼šå¦ä¸€åœºæ¯”èµ›çš„åˆ†æ•°ï¼‰
ZADD player_scores_2 95 "zhangsan" 92 "lisi" 98 "zhaoliu"

# ZUNIONSTOREï¼šåˆå¹¶2ä¸ªé›†åˆçš„å¹¶é›†ï¼Œç»“æœå­˜å…¥union_scoresï¼Œåˆ†æ•°æ±‚å’Œ
ZUNIONSTORE union_scores 2 player_scores player_scores_2 AGGREGATE SUM
# æŸ¥çœ‹å¹¶é›†ç»“æœ
ZRANGE union_scores 0 -1 WITHSCORES  

# ZINTERSTOREï¼šè®¡ç®—2ä¸ªé›†åˆçš„äº¤é›†ï¼Œç»“æœå­˜å…¥inter_scoresï¼Œåˆ†æ•°å–æœ€å¤§å€¼
ZINTERSTORE inter_scores 2 player_scores player_scores_2 AGGREGATE MAX
# æŸ¥çœ‹äº¤é›†ç»“æœ
ZRANGE inter_scores 0 -1 WITHSCORES  


# ========== å­—å…¸åºæŸ¥è¯¢ï¼ˆåˆ†æ•°ç›¸åŒåœºæ™¯ï¼‰ ==========
# åˆ›å»ºåˆ†æ•°å…¨ä¸º0çš„é›†åˆï¼ˆå­—å…¸åºæŸ¥è¯¢è¦æ±‚åˆ†æ•°ä¸€è‡´ï¼‰
ZADD dict_zset 0 "apple" 0 "banana" 0 "cherry" 0 "date"

# ZLEXCOUNTï¼šç»Ÿè®¡å­—å…¸åºåŒºé—´å†…çš„æˆå‘˜æ•°ï¼ˆ[b (d è¡¨ç¤ºbâ‰¤x<dï¼‰
# è¾“å‡ºï¼š2ï¼ˆbananaã€cherryï¼‰
ZLEXCOUNT dict_zset [b (d
# ZRANGEBYLEXï¼šæŒ‰å­—å…¸åºæŸ¥[b,c]åŒºé—´çš„æˆå‘˜
ZRANGEBYLEX dict_zset [b [c  


# ========== å¤§æ•°æ®é‡éå† ==========
# ZSCANï¼šæ¸¸æ ‡å¼éå†ï¼ˆé€‚åˆç™¾ä¸‡çº§å¤§é›†åˆï¼‰ï¼ŒåŒ¹é…ä»¥zå¼€å¤´çš„æˆå‘˜ï¼Œæ¯æ¬¡è¿”å›5ä¸ª
ZSCAN player_scores 0 MATCH "z*" COUNT 5

# ========== æ‰¹é‡æ“ä½œï¼ˆRedis 6.2+ï¼‰ ==========
# ZMSCOREï¼šæ‰¹é‡è·å–å¤šä¸ªæˆå‘˜çš„åˆ†æ•°ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
ZMSCORE player_scores "zhangsan" "lisi" "zhaoliu"
```



![å‘½ä»¤æ‰§è¡Œç¤ºä¾‹å›¾1](redis1.png)

![å‘½ä»¤æ‰§è¡Œç¤ºä¾‹å›¾2](redis2.png)

![å‘½ä»¤æ‰§è¡Œç¤ºä¾‹å›¾3](redis3.png)



**å…³é”®æ³¨æ„ç‚¹**

- ZSet çš„ Score æ˜¯åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œéœ€æ³¨æ„ç²¾åº¦ä¸¢å¤±ï¼ˆåæ–‡ä¼šç”¨ Long ç»„åˆåˆ†æ•°è§„é¿ï¼‰ï¼›
- å• ZSet å»ºè®®æ•°æ®é‡ä¸è¶…è¿‡ 1000 ä¸‡ï¼ˆRedis å• Key æé™ï¼‰ï¼›
- é¿å…ç”¨ ZRANGE 0 -1 éå†å¤§é›†åˆï¼Œä¼˜å…ˆç”¨ ZSCAN æ¸¸æ ‡éå†ã€‚




## äºŒã€å®æˆ˜



ä¸ºäº†æ–¹ä¾¿æ“ä½œredis,ä½¿ç”¨Redissonçš„RScoredSortedSetï¼Œç®€åŒ–äº†å¼€å‘å¤æ‚åº¦ã€‚



### 1ã€Maven ä¾èµ–

```xml
<properties>
    <java.version>17</java.version>
    <redisson.version>3.52.0</redisson.version>
</properties>
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <!-- redissoné›†æˆ -->
    <dependency>
        <groupId>org.redisson</groupId>
        <artifactId>redisson-spring-boot-starter</artifactId>
        <version>${redisson.version}</version>
    </dependency>
</dependencies>
```



### 2ã€é…ç½®æ–‡ä»¶

```yaml
spring:
  application:
    name: springboot-redis-zset
  data:
    redis:
      host: 127.0.0.1
      port: 6379
      password: yourPassword
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 200
          max-idle: 8
          min-idle: 0
          max-wait: 1000ms

# è‡ªå®šä¹‰æ’åé…ç½®
rank:
  # åˆ†ç‰‡æ•°ï¼ˆ1äº¿/100=1000ä¸‡/åˆ†ç‰‡ï¼Œå•èŠ‚ç‚¹Rediså¯æ‰¿è½½ï¼‰
  shard-count: 200
  key-prefix: "game:player:rank:"

```



### 3ã€å½“åˆ†æ•°ç›¸åŒæ—¶ï¼Œå¦‚ä½•ä¿è¯å…¬å¹³ï¼Ÿ

åœ¨å®é™…åœºæ™¯ä¸­ï¼ˆå¦‚ç‹è€…è£è€€æ®µä½æ’åï¼‰ï¼Œå¤§é‡ç©å®¶å¯èƒ½æ‹¥æœ‰ç›¸åŒåˆ†æ•°ï¼Œä½†ç³»ç»Ÿè¦æ±‚**å…ˆè¾¾åˆ°è¯¥åˆ†æ•°çš„ç©å®¶æ’åæ›´é å‰**ã€‚



æˆ‘ä»¬è®¾è®¡äº†åˆ†æ•°ç»„åˆç­–ç•¥ï¼šå°†åŸå§‹åˆ†æ•°ä¸æ—¶é—´æˆ³ç»„åˆæˆä¸€ä¸ªLongç±»å‹æ•°å€¼ï¼š

```java
// ä¸»åˆ†æ•°å ç”¨é«˜30ä½ï¼Œæ—¶é—´æˆ³å ç”¨ä½34ä½
private static final int TIMESTAMP_BITS = 34;
private static final long TIMESTAMP_MASK = (1L << TIMESTAMP_BITS) - 1;

public static long combineScore(long mainScore, long updateTime) {
    if (mainScore < 0 || mainScore > 1_000_000_000) {
        throw new IllegalArgumentException("ä¸»åˆ†æ•°å¿…é¡»åœ¨0-10äº¿ä¹‹é—´: " + mainScore);
    }
    
    long timestampPart = updateTime & TIMESTAMP_MASK;
    timestampPart = TIMESTAMP_MASK - timestampPart; // åè½¬æ—¶é—´æˆ³
    
    return (mainScore << TIMESTAMP_BITS) | timestampPart;
}
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†**ç›¸åŒåˆ†æ•°ä¸‹ï¼Œå…ˆè¾¾åˆ°åˆ†æ•°çš„ç©å®¶è·å¾—æ›´é«˜çš„ç»„åˆåˆ†æ•°**ï¼Œä»è€Œæ’åæ›´é å‰ã€‚

æˆ‘ä»¬è¿˜æœ‰éœ€è¦ä¸€ä¸ªé€šè¿‡ç»„åˆåˆ†æ•°å¾—åˆ°çœŸæ­£çš„ä¸»åˆ†æ•°çš„æ–¹æ³•ï¼š

```java
public static long parseMainScore(double combinedScore) {
    // å³ç§»34ä½è·å–ä¸»åˆ†æ•°
    return (long)combinedScore >>> TIMESTAMP_BITS;
}
```



### 4ã€åˆ†ç‰‡ç­–ç•¥ï¼šå¹³è¡¡è´Ÿè½½ä¸æŸ¥è¯¢æ•ˆç‡

å•ZSetæ‰¿è½½1äº¿æ•°æ®ä»æœ‰å‹åŠ›ï¼Œæˆ‘ä»¬é‡‡ç”¨**å“ˆå¸Œåˆ†ç‰‡**ç­–ç•¥ï¼š

- åˆ†ç‰‡æ•°è¿‡å¤šï¼ˆå¦‚ 1000ï¼‰â†’ å…¨å±€æ’åéœ€æŸ¥è¯¢ 1000 ä¸ªåˆ†ç‰‡ï¼Œæ€§èƒ½ä¸‹é™.
- åˆ†ç‰‡æ•°è¿‡å°‘ï¼ˆå¦‚ 10ï¼‰â†’ å•ä¸ª ZSet æ•°æ®é‡ 1 äº¿ï¼ŒRedis å• Key ç“¶é¢ˆ

- å•åˆ†ç‰‡æ•°æ®é‡æ§åˆ¶åœ¨ 500 ä¸‡ï½1000 ä¸‡ï¼Œ1 äº¿ç©å®¶å»ºè®® 100~200 ä¸ªåˆ†ç‰‡



**åˆ†ç‰‡é”®è®¡ç®—**ï¼š

```java
/**
 * è®¡ç®—ç©å®¶æ‰€å±çš„åˆ†ç‰‡Key
 * @param playerId ç©å®¶ID
 * @param rankType æ’åç±»å‹
 * @return åˆ†ç‰‡é”®
 */
private String getShardKey(Long playerId, int rankType) {
    int shardIndex = (int) (playerId % shardCount);
    return rankKeyPrefix + rankType + ":" + shardIndex;
}
```

### 5ã€æ ¸å¿ƒæœåŠ¡ç±»è®¾è®¡



```java
@Service
@RequiredArgsConstructor
public class PlayerRankService {
    private final RedissonClient redissonClient;
    
    // åˆ†ç‰‡é…ç½®
    @Value("${rank.shard-count:100}")
    private int shardCount;
    
    @Value("${rank.key-prefix:game:player:rank:}")
    private String rankKeyPrefix;
    
    // å…³é”®æ–¹æ³•ï¼šå®æ—¶æ›´æ–°ç©å®¶åˆ†æ•°
    public void updatePlayerScore(Long playerId, int rankType, 
                                  long mainScore, long updateTime) {
        double combineScore = combineScore(mainScore, updateTime);
        String shardKey = getShardKey(playerId, rankType);
        RScoredSortedSet<Long> rankSet = redissonClient.getScoredSortedSet(shardKey);
        
        // åŸå­æ“ä½œï¼šæ·»åŠ æˆ–æ›´æ–°åˆ†æ•°
        rankSet.add(combineScore, playerId);
    }
}
```

### 6ã€è·å–ç©å®¶æ‰€åœ¨çš„å…¨å±€æ’å

```java
/**
 * è·å–ç©å®¶è¯¦ç»†ä¿¡æ¯
 */
@SneakyThrows
public RankItem getPlayerRankDetail(Long playerId, int rankType) {
    String shardKey = getShardKey(playerId, rankType);
    RScoredSortedSet<Long> rankSet = redissonClient.getScoredSortedSet(shardKey);
    // è·å–ç©å®¶æ’åºåˆ†æ•°
    Double combineScore = rankSet.getScore(playerId);
    if (combineScore == null) {
        return null;
    }
    // å¹¶è¡Œè®¡ç®—æ‰€æœ‰åˆ†ç‰‡ä¸­åˆ†æ•°å¤§äºå½“å‰ç©å®¶çš„æ•°é‡
    List<CompletableFuture<Integer>> futures = new ArrayList<>();
    for (int i = 0; i < shardCount; i++) {
        String currentShardKey = rankKeyPrefix + rankType + ":" + i;
        CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {
            RScoredSortedSet<Long> shardSet = redissonClient.getScoredSortedSet(currentShardKey);
            // å¯¹äºå½“å‰ç©å®¶æ‰€åœ¨çš„åˆ†ç‰‡ï¼Œæ’é™¤ç­‰äºè‡ªå·±åˆ†æ•°çš„æƒ…å†µ
            if (currentShardKey.equals(shardKey)) {
                return shardSet.count(combineScore, false, Double.MAX_VALUE, true);
            }
            // å¯¹äºå…¶ä»–åˆ†ç‰‡ï¼Œç»Ÿè®¡æ‰€æœ‰åˆ†æ•°å¤§äºå½“å‰åˆ†æ•°çš„ç©å®¶
            else {
                return shardSet.count(combineScore, false, Double.MAX_VALUE, true);
            }
        });
        futures.add(future);
    }

    // æ±‡æ€»æ‰€æœ‰åˆ†ç‰‡çš„ç»“æœ
    long higherCount = 0;
    for (CompletableFuture<Integer> future : futures) {
        higherCount += future.get();
    }

    long rank = higherCount + 1;
    long mainScore = parseMainScore(combineScore);
    return new RankItem(playerId, mainScore, rank, combineScore);
}
```

- æˆ‘ä»¬é‡‡ç”¨**å¹¶è¡ŒæŸ¥è¯¢+æœ¬åœ°èšåˆ**ç­–ç•¥

### 7ã€æŸ¥è¯¢æ¦œå•å‰Nå

```java
/**
 * è·å–æ¦œå•å‰Nåï¼ˆå¸¦åˆ†æ•°å’Œæ’åï¼‰
 */
public List<RankItem> getTopRankList(int rankType, int start, int end) throws ExecutionException, InterruptedException {
    int neededCount = end; // éœ€è¦è·å–åˆ°ç¬¬endå

    // ä»æ¯ä¸ªåˆ†ç‰‡è·å–å‰neededCountå
    List<CompletableFuture<List<ScoredEntry<Integer>>>> futures = new ArrayList<>();
    for (int i = 0; i < shardCount; i++) {
        String shardKey = rankKeyPrefix + rankType + ":" + i;
        CompletableFuture<List<ScoredEntry<Integer>>> future = CompletableFuture.supplyAsync(() -> {
            RScoredSortedSet<Integer> rankSet = redissonClient.getScoredSortedSet(shardKey);
            // è·å–æ¯ä¸ªåˆ†ç‰‡çš„å‰neededCountåï¼ˆåŒ…å«åˆ†æ•°ï¼‰
            Collection<ScoredEntry<Integer>> entries = rankSet.entryRangeReversed(0, neededCount - 1);
            return new ArrayList<>(entries);
        });
        futures.add(future);
    }

    // åˆå¹¶æ‰€æœ‰åˆ†ç‰‡ç»“æœ
    List<ScoredEntry<Integer>> allEntries = new ArrayList<>();
    for (CompletableFuture<List<ScoredEntry<Integer>>> future : futures) {
        allEntries.addAll(future.get());
    }

    // æŒ‰åˆ†æ•°é™åºæ’åº
    allEntries.sort((a, b) -> Double.compare(b.getScore(), a.getScore()));

    // è½¬æ¢ä¸ºRankItemåˆ—è¡¨ï¼Œå¹¶æ·»åŠ æ’å
    List<RankItem> result = new ArrayList<>();
    int currentRank = 0;
    Double lastScore = null;
    Long actualRank = 1L;

    for (int i = 0; i < allEntries.size(); i++) {
        ScoredEntry<Integer> entry = allEntries.get(i);
        double combineScore = entry.getScore();
        int playerId = entry.getValue();

        // è§£æä¸»åˆ†æ•°
        long mainScore = parseMainScore(combineScore);
        actualRank = (long) (i + 1);
        result.add(new RankItem(playerId, mainScore, actualRank, combineScore));
    }

    // è¿”å›æŒ‡å®šèŒƒå›´çš„æ’å
    int fromIndex = Math.min(start - 1, result.size());
    int toIndex = Math.min(end, result.size());
    return result.subList(fromIndex, toIndex);
}
```

- å¯¹äºæ¦œå•å‰NåæŸ¥è¯¢ï¼Œæˆ‘ä»¬é‡‡ç”¨**å„åˆ†ç‰‡é¢„å–+å…¨å±€å½’å¹¶**ç­–ç•¥
- è¿™æ ·æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœendå¦‚æœå¾ˆå¤§ï¼Œåœ¨`allEntries.addAll` å¯èƒ½ä¼šå­˜åœ¨å†…å­˜æº¢å‡ºå¼•å‘ OOMï¼Œæ‰€ä»¥æäº†ä¸ªä¼˜åŒ–ç‰ˆ



```java
@SneakyThrows
public List<RankItem> getTopRankListOptimize(int rankType, int start, int end) {
    if (start < 1 || end < start) {
        throw new IllegalArgumentException("æ’åèŒƒå›´æ— æ•ˆ: start=" + start + ", end=" + end);
    }
    // éœ€è¦è·å–çš„å®é™…æ•°é‡ï¼ˆä»ç¬¬1ååˆ°ç¬¬endåï¼‰
    int needCount = end;
    // ========== ä½¿ç”¨æœ€å°å †èšåˆæ‰€æœ‰åˆ†ç‰‡çš„Top N ==========
    // å®šä¹‰æœ€å°å †ï¼šå †é¡¶æ˜¯åˆ†æ•°æœ€å°çš„ï¼Œæ–¹ä¾¿æ·˜æ±°
    PriorityQueue<ScoredEntry<Integer>> minHeap = new PriorityQueue<>(
            needCount + 1, // å®¹é‡ç¨å¤§ï¼Œé¿å…é¢‘ç¹æ‰©å®¹
            Comparator.comparingDouble(ScoredEntry::getScore) // æŒ‰åˆ†æ•°å‡åº
    );

    // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å–needCountå
    List<CompletableFuture<Void>> futures = new ArrayList<>(shardCount);
    for (int i = 0; i < shardCount; i++) {
        final int shardIndex = i;
        CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
            try {
                String shardKey = rankKeyPrefix + rankType + ":" + shardIndex;
                RScoredSortedSet<Integer> rankSet = redissonClient.getScoredSortedSet(shardKey);

                // ä»æ¯ä¸ªåˆ†ç‰‡è·å–å‰needCountåï¼ˆé™åºï¼šåˆ†æ•°é«˜åœ¨å‰ï¼‰
                Collection<ScoredEntry<Integer>> entries = rankSet.entryRangeReversed(0, needCount - 1);

                // åŒæ­¥åŠ é”æ›´æ–°å †ï¼ˆå¤šçº¿ç¨‹å®‰å…¨ï¼‰
                synchronized (minHeap) {
                    for (ScoredEntry<Integer> entry : entries) {
                        minHeap.offer(entry);
                        // å †å¤§å°è¶…è¿‡needCountï¼Œå¼¹å‡ºæœ€å°å€¼ï¼ˆæ·˜æ±°æœºåˆ¶ï¼‰
                        if (minHeap.size() > needCount) {
                            minHeap.poll();
                        }
                    }
                }
            } catch (Exception e) {
                log.error("æŸ¥è¯¢åˆ†ç‰‡ {} å¤±è´¥", shardIndex, e);
            }
        }, executor);
        futures.add(future);
    }

    // ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡æŸ¥è¯¢å®Œæˆ
    CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).get();

    // å †è½¬åˆ—è¡¨å¹¶é™åºæ’åºï¼ˆåˆ†æ•°é«˜åœ¨å‰ï¼‰
    List<ScoredEntry<Integer>> topEntries = new ArrayList<>(minHeap);
    topEntries.sort((a, b) -> Double.compare(b.getScore(), a.getScore())); // é™åº

    // ========== ç¬¬ä¸‰æ­¥ï¼šè½¬æ¢ä¸ºRankItemï¼Œå¤„ç†åŒåˆ†æ’åé€»è¾‘ ==========
    List<RankItem> result = new ArrayList<>(topEntries.size());
    // çœŸå®æ’åï¼ˆåŒåˆ†æ’åç›¸åŒï¼‰
    long actualRank = 1;
    // å½“å‰ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
    int currentIndex = 0;

    for (ScoredEntry<Integer> entry : topEntries) {
        double combineScore = entry.getScore();
        Integer playerId = entry.getValue();
        // è§£æä¸»åˆ†æ•°
        long mainScore = parseMainScore(combineScore);
        // åˆ†æ•°å˜åŒ–ï¼šæ’å = å½“å‰ç´¢å¼• + 1
        actualRank = currentIndex + 1;
        // æ„å»ºRankItem
        result.add(new RankItem(playerId, mainScore, actualRank, combineScore));
        currentIndex++;
    }

    // æˆªå–æŒ‡å®šèŒƒå›´ [start, end]
    // æ³¨æ„ï¼šstart/end ä»1å¼€å§‹ï¼Œåˆ—è¡¨ç´¢å¼•ä»0å¼€å§‹
    int fromIndex = Math.max(0, start - 1);
    int toIndex = Math.min(end, result.size());
    if (fromIndex >= toIndex) {
        return new ArrayList<>(); // èŒƒå›´æ— æ•ˆï¼Œè¿”å›ç©ºåˆ—è¡¨
    }
    return result.subList(fromIndex, toIndex);
}
```

- å®šä¹‰æœ€å°å †:minHeap,æ·»åŠ åŒæ­¥é”ï¼Œé¿å…å¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼ˆConcurrentModificationExceptionï¼‰ã€‚
- éšä¾¿è¿™æ ·é¿å…äº†å†…å­˜æº¢å‡ºï¼Œä½†æ˜¯å› ä¸ºåŠ äº†é”ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œå¦‚æœendå¯æ§ï¼Œç¬¬ä¸€ç‰ˆæ›´å¥½ï¼Œæ ¹æ®ä¸šåŠ¡è‡ªè¡Œå†³æ–­



### 8ã€è·å–ç©å®¶å‘¨å›´çš„æ’å

```java
/**
 * è·å–ç©å®¶å‘¨å›´çš„æ’åï¼ˆç”¨äºæ˜¾ç¤ºè‡ªå·±åŠå‰åå‡ åï¼‰
 */
public List<RankItem> getSurroundingRanks(Long playerId, int rankType, int before, int after)
        throws ExecutionException, InterruptedException {
    RankItem playerRank = getPlayerRankDetail(playerId, rankType);
    if (playerRank == null) {
        return new ArrayList<>();
    }
    long playerRankValue = playerRank.getRank();
    int start = (int) Math.max(1, playerRankValue - before);
    int end = (int) (playerRankValue + after);

    List<RankItem> range = getRankRange(rankType, start, end);
    // æ ‡è®°å½“å‰ç©å®¶
    for (RankItem item : range) {
        if (item.getPlayerId().equals(playerId)) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ ‡è®°ï¼Œæˆ–è€…è°ƒç”¨æ–¹æ ¹æ®IDåˆ¤æ–­
            item.setIsCurrentUser(Boolean.TRUE);
        }
    }
    return range;
}
```



### 9ã€æµ‹è¯•æ¥å£Controller


```java
import lombok.RequiredArgsConstructor;
import lombok.SneakyThrows;
import org.springframework.web.bind.annotation.*;
import top.lrshuai.redis.zset.service.PlayerRankService;
import top.lrshuai.redis.zset.vo.R;
import top.lrshuai.redis.zset.vo.RankItem;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.concurrent.*;
import java.util.stream.Collectors;

/**
 * ç©å®¶æ’åæ¥å£å±‚
 */
@RestController
@RequestMapping("/api/rank")
@RequiredArgsConstructor
public class PlayerRankController {

    private final PlayerRankService playerRankService;
    // æ‰¹æ¬¡
    private final long BATCH_SIZE=10000;
    private final long TOTAL=100000000;

    private final ThreadLocalRandom random = ThreadLocalRandom.current();

    // æ ¸å¿ƒçº¿ç¨‹æ± 
    private final ExecutorService executor = new ThreadPoolExecutor(
            5, // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆåˆå§‹å¹¶å‘ï¼‰
            10, // æœ€å¤§çº¿ç¨‹æ•°ï¼ˆå³°å€¼å¹¶å‘ï¼‰
            60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000), // ä»»åŠ¡é˜Ÿåˆ—ï¼Œé¿å…çº¿ç¨‹è¿‡å¤š
            new ThreadPoolExecutor.CallerRunsPolicy() // é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œï¼ˆé¿å…ä»»åŠ¡ä¸¢å¤±ï¼‰
    );


    /**
     * æ‰¹é‡ç”Ÿæˆç¤ºä¾‹æ’åæ•°æ®
     */
    @GetMapping("/batchAdd")
    public R<String> batchAddPlayerData(
            @RequestParam(defaultValue = "1") int rankType,
            @RequestParam(defaultValue = "100") int totalCount,
            @RequestParam(defaultValue = "0") long beginId, //ä»ä»€ä¹ˆç”¨æˆ·IDå¼€å§‹
            @RequestParam(defaultValue = "100") long minScore,
            @RequestParam(defaultValue = "30000") long maxScore) {
        try {
            if (totalCount <= 0 || minScore > maxScore) {
                return R.fail("å‚æ•°é”™è¯¯ï¼šæ•°é‡éœ€å¤§äº0ï¼Œæœ€å°åˆ†æ•°ä¸èƒ½å¤§äºæœ€å¤§åˆ†æ•°");
            }

            long batchNum = totalCount / BATCH_SIZE;
            long remainCount = totalCount % BATCH_SIZE;
            long updateTime = System.currentTimeMillis();

            // åˆ›å»ºCountDownLatchï¼Œç”¨äºç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            CountDownLatch latch = new CountDownLatch((int)(batchNum + (remainCount > 0 ? 1 : 0)));

            // æäº¤åˆ†æ‰¹ä»»åŠ¡
            for (long batch = 0; batch < batchNum; batch++) {
                long startId = batch * BATCH_SIZE + 1+beginId; // ç©å®¶IDèµ·å§‹å€¼
                long endId = (batch + 1) * BATCH_SIZE+beginId;
                submitBatchTaskWithLatch(rankType, startId, endId, minScore, maxScore, updateTime, latch);
                // æ¯æ‰¹æäº¤åç¨å¾®åœé¡¿ä¸€ä¸‹ï¼Œé¿å…å‹åŠ›è¿‡å¤§
                Thread.sleep(100);
            }

            // å¤„ç†å‰©ä½™æ•°æ®
            if (remainCount > 0) {
                long startId = batchNum * BATCH_SIZE + 1+beginId;
                long endId = batchNum * BATCH_SIZE + remainCount+beginId;
                submitBatchTaskWithLatch(rankType, startId, endId, minScore, maxScore, updateTime, latch);
            }

            // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡ä»»åŠ¡å®Œæˆ
            boolean allCompleted = latch.await(5, TimeUnit.MINUTES); // è®¾ç½®5åˆ†é’Ÿè¶…æ—¶
            if (!allCompleted) {
                return R.fail("æ‰¹é‡ç”Ÿæˆä»»åŠ¡è¶…æ—¶ï¼Œéƒ¨åˆ†æ•°æ®å¯èƒ½æœªå®Œæˆ");
            }

            return R.ok("æ‰¹é‡ç”Ÿæˆ" + totalCount + "æ¡æ’åæ•°æ®æˆåŠŸï¼Œæ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return R.fail("æ‰¹é‡æ·»åŠ è¢«ä¸­æ–­ï¼š" + e.getMessage());
        } catch (Exception e) {
            return R.fail("æ‰¹é‡æ·»åŠ å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * æäº¤å•æ‰¹æ’å…¥ä»»åŠ¡ï¼ˆå¸¦åŒæ­¥é”ï¼‰
     */
    private void submitBatchTaskWithLatch(int rankType, long startId, long endId,
                                          long minScore, long maxScore, long updateTime,
                                          CountDownLatch latch) {
        executor.submit(() -> {
            try {
                for (long i = startId; i <= endId; i++) {
                    // ç”Ÿæˆéšæœºä¸»åˆ†æ•°
//                    long mainScore = minScore + random.nextLong() % (maxScore - minScore + 1);
                    // ä¸ºäº†æ–¹ä¾¿æµ‹è¯•å®šä½ï¼Œåˆ†æ•°å’Œid æœ‰å…³
                    long mainScore = TOTAL-i;
                    System.out.println("i=" + i + ", mainScore=" + mainScore);
                    // è°ƒç”¨æœåŠ¡æ’å…¥
                    playerRankService.updatePlayerScore(i, rankType, mainScore, updateTime);
                }
                System.out.println("æ‰¹æ¬¡å®Œæˆï¼šplayer_" + startId + " ~ player_" + endId);
            } catch (Exception e) {
                System.err.println("æ‰¹æ¬¡æ’å…¥å¤±è´¥ï¼š" + startId + "~" + endId + "ï¼ŒåŸå› ï¼š" + e.getMessage());
            } finally {
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡Šæ”¾é”
                latch.countDown();
            }
        });
    }

    /**
     * æ›´æ–°ç©å®¶åˆ†æ•°ï¼ˆæ ¸å¿ƒæ¥å£ï¼‰
     *
     * @param playerId  ç©å®¶ID
     * @param rankType  æ¦œå•ç±»å‹ï¼ˆ1=æˆ˜åŠ›æ¦œï¼Œ2=ç§¯åˆ†æ¦œï¼‰
     * @param mainScore ä¸»åˆ†æ•°ï¼ˆå¦‚æˆ˜åŠ›å€¼ï¼‰
     */
    @PostMapping("/update")
    public R<String> updateScore(
            @RequestParam Long playerId,
            @RequestParam int rankType,
            @RequestParam long mainScore) {
        // ç”¨å½“å‰æ—¶é—´æˆ³ä½œä¸ºæ¬¡åˆ†æ•°ï¼Œä¿è¯åŒä¸»åˆ†æ•°æ—¶çš„æ’åº
        long updateTime = System.currentTimeMillis();
        playerRankService.updatePlayerScore(playerId, rankType, mainScore, updateTime);
        return R.ok("åˆ†æ•°æ›´æ–°æˆåŠŸ");
    }


    /**
     * æŸ¥è¯¢æ¦œå•å‰Nåç©å®¶
     *
     * @param rankType æ¦œå•ç±»å‹
     * @param start    èµ·å§‹æ’åï¼ˆ1å¼€å§‹ï¼‰
     * @param end      ç»“æŸæ’åï¼ˆ1å¼€å§‹ï¼‰
     */
    @SneakyThrows
    @GetMapping("/top/{rankType}/{start}/{end}")
    public R getTopRankList(@PathVariable int rankType, @PathVariable int start, @PathVariable int end) {
        return R.ok(playerRankService.getTopRankList(rankType, start, end));
    }

    /**
     * è·å–ç©å®¶æ’åè¯¦æƒ…ï¼ˆåŒ…å«åˆ†æ•°å’Œæ’åï¼‰
     *
     * @param playerId ç©å®¶ID
     * @param rankType æ¦œå•ç±»å‹
     */
    @SneakyThrows
    @GetMapping("/detail/{rankType}/{playerId}")
    public R getPlayerRankDetail(@PathVariable int rankType,
                                 @PathVariable Long playerId) {
        RankItem rankDetail = playerRankService.getPlayerRankDetail(playerId, rankType);
        if (rankDetail == null) {
            return R.fail("ç©å®¶ä¸å­˜åœ¨æˆ–æœªå‚ä¸æ’å");
        }
        return R.ok(rankDetail);
    }

    /**
     * è·å–æŒ‡å®šåˆ†æ•°çš„æ‰€æœ‰ç©å®¶
     *
     * @param rankType  æ¦œå•ç±»å‹
     * @param mainScore ä¸»åˆ†æ•°
     */
    @SneakyThrows
    @GetMapping("/players-by-score/{rankType}/{mainScore}")
    public R getPlayersByMainScore(@PathVariable int rankType,
                                   @PathVariable long mainScore) {
        List<Long> players = playerRankService.getPlayersByMainScore(rankType, mainScore);
        return R.ok(players);
    }

    /**
     * æ‰¹é‡è·å–ç©å®¶æ’åä¿¡æ¯
     *
     * @param rankType  æ¦œå•ç±»å‹
     * @param playerIds ç©å®¶IDåˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”
     */
    @SneakyThrows
    @GetMapping("/batch-detail/{rankType}")
    public R batchGetRankDetails(@PathVariable int rankType,
                                 @RequestParam String playerIds) {
        List<Long> idList = Arrays.stream(playerIds.split(",")).map(Long::parseLong).collect(Collectors.toList());
        List<RankItem> rankDetails = playerRankService.batchGetRankDetails(idList, rankType);
        return R.ok(rankDetails);
    }

    /**
     * è·å–ç©å®¶å‘¨å›´çš„æ’åï¼ˆæ˜¾ç¤ºç©å®¶åŠå‰åå‡ åï¼‰
     *
     * @param rankType æ¦œå•ç±»å‹
     * @param playerId ç©å®¶ID
     * @param before   å‘å‰è·å–å‡ å
     * @param after    å‘åè·å–å‡ å
     */
    @SneakyThrows
    @GetMapping("/surrounding/{rankType}/{playerId}")
    public R getSurroundingRanks(@PathVariable int rankType,
                                 @PathVariable Long playerId,
                                 @RequestParam(defaultValue = "5") int before,
                                 @RequestParam(defaultValue = "5") int after) {
        List<RankItem> surrounding = playerRankService.getSurroundingRanks(playerId, rankType, before, after);
        return R.ok(surrounding);
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢æ’è¡Œæ¦œ
     *
     * @param rankType æ¦œå•ç±»å‹
     * @param page     é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
     * @param pageSize æ¯é¡µå¤§å°
     */
    @SneakyThrows
    @GetMapping("/page/{rankType}")
    public R getRankByPage(@PathVariable int rankType,
                           @RequestParam(defaultValue = "1") int page,
                           @RequestParam(defaultValue = "20") int pageSize) {
        if (page < 1 || pageSize < 1 || pageSize > 1000) {
            return R.fail("å‚æ•°é”™è¯¯ï¼šé¡µç éœ€å¤§äº0ï¼Œæ¯é¡µå¤§å°åœ¨1-1000ä¹‹é—´");
        }

        int start = (page - 1) * pageSize + 1;
        int end = page * pageSize;

        List<RankItem> rankList = playerRankService.getTopRankList(rankType, start, end);
        return R.ok(rankList);
    }

    /**
     * è·å–æ’è¡Œæ¦œç»Ÿè®¡ä¿¡æ¯
     *
     * @param rankType æ¦œå•ç±»å‹
     */
    @SneakyThrows
    @GetMapping("/stats/{rankType}")
    public R getRankStats(@PathVariable int rankType) {
        // è¿™é‡Œå¯ä»¥è¿”å›ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æ€»ç©å®¶æ•°ã€å¹³å‡åˆ†æ•°ç­‰
        // æ³¨æ„ï¼šè¿™äº›æ•°æ®å¯èƒ½éœ€è¦é¢å¤–è®¡ç®—ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹
        Map<String, Object> stats = new ConcurrentHashMap<>();
        stats.put("rankType", rankType);
        stats.put("timestamp", System.currentTimeMillis());

        // è·å–å‰10å
        List<RankItem> top10 = playerRankService.getTopRankList(rankType, 1, 10);
        stats.put("top10", top10);

        // è·å–ç©å®¶æ€»æ•°ï¼ˆéœ€è¦éå†æ‰€æœ‰åˆ†ç‰‡ï¼‰
        long totalPlayers = 0;
        for (int i = 0; i < playerRankService.getShardCount(); i++) {
            String shardKey = playerRankService.getRankKeyPrefix() + rankType + ":" + i;
            org.redisson.api.RScoredSortedSet<Long> rankSet = playerRankService.getRedissonClient().getScoredSortedSet(shardKey);
            totalPlayers += rankSet.size();
        }
        stats.put("totalPlayers", totalPlayers);

        return R.ok(stats);
    }


}
```


![æ¥å£è¯·æ±‚æµ‹è¯•æ·»åŠ æ•°æ®](redis4.png)


- æˆ‘çš„ç”µè„‘é…ç½®ä¸€èˆ¬ï¼Œæµ‹è¯•äº†æ–°å¢100ä¸‡æ•°æ®ï¼Œéœ€è¦76ç§’ã€‚



![æ¥å£è¯·æ±‚æµ‹è¯•æ•°æ®](redis6.png)


![æ¥å£è¯·æ±‚æµ‹è¯•æ•°æ®](redis5.png)



## ä¸‰ã€ç»“å°¾



å®ç°çš„æ€è·¯å’Œä»£ç å†™å®Œäº†ï¼Œè™½ç„¶æœ‰ç‚¹ç²—ç³™ï¼Œä½†æ˜¯æ€è·¯æ˜¯æ²¡é—®é¢˜çš„ï¼Œé€šè¿‡**åˆ†ç‰‡ç­–ç•¥**ã€**åˆ†æ•°ç»„åˆç®—æ³•**å’Œ**å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–**ï¼Œå®ç°äº†é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ’åæœåŠ¡ã€‚



#### èµ„æºè·å–ï¼š

æœ¬æ–‡å®Œæ•´ä»£ç å·²ä¸Šä¼ è‡³ GitHubï¼Œæ¬¢è¿ Star â­ å’Œ Fork

- Giteeåœ°å€ï¼šhttps://gitee.com/rstyro/enterprise-examples
- Githubåœ°å€ï¼šhttps://github.com/rstyro/enterprise-examples



å¦‚æœè¿™ç¯‡æ–‡ç« å¸®åˆ°äº†ä½ ï¼Œæ¬¢è¿ç‚¹èµã€æ”¶è—ã€è½¬å‘ï½å…³æ³¨æˆ‘ï¼Œåç»­åˆ†äº«æ›´å¤šé«˜å¹¶å‘ã€åˆ†å¸ƒå¼å®æˆ˜æ–¹æ¡ˆï¼ğŸ”¥

