---
title: åˆ«å†è®©æ¥å£è¢«åˆ·çˆ†äº†ï¼èµ„æ·±æ¶æ„å¸ˆçš„é˜²åˆ·å®æˆ˜ç¬”è®°ï¼Œé™„å®Œæ•´ä»£ç 
tags: [Spring Boot]
categories: Java
date: 2025-11-14 18:06:47
---

>  é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ¥å£é˜²åˆ·æ˜¯ç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦ä¿éšœã€‚ä¸Šä¸€ç¯‡æˆ‘ä»¬å·²ç»ä»‹ç»äº†å›ºå®šè®¡æ•°å™¨é™æµå’Œä»¤ç‰Œæ¡¶é™æµï¼Œä»Šå¤©ç»§ç»­åˆ†äº«æ¼æ¡¶é™æµå’Œæ»‘åŠ¨æ—¶é—´çª—å£é™æµè¿™ä¸¤ç§ç»å…¸ç®—æ³•ã€‚


<!--more-->

## ä¸€ã€æ¼æ¡¶é™æµ

### 1ã€ä»€ä¹ˆæ˜¯æ¼æ¡¶é™æµ



æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰æ˜¯ä¸€ç§ç»å…¸çš„æµé‡æ•´å½¢ç®—æ³•ï¼Œå®ƒæ¨¡æ‹Ÿä¸€ä¸ªåº•éƒ¨æœ‰å›ºå®šå¤§å°å‡ºæ°´å£çš„æ¡¶ã€‚æ— è®ºæµå…¥é€Ÿåº¦å¤šå¿«ï¼Œæµå‡ºé€Ÿç‡éƒ½ä¿æŒæ’å®šï¼Œè¿™ç¡®ä¿äº†æµé‡çš„å¹³æ»‘è¾“å‡ºã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**

- **å›ºå®šæµå‡ºé€Ÿç‡**ï¼šæ— è®ºè¾“å…¥å¤šä¹ˆä¸ç¨³å®šï¼Œè¾“å‡ºå§‹ç»ˆä¿æŒæ’å®šé€Ÿç‡
- **æ¡¶å®¹é‡é™åˆ¶**ï¼šå½“æ¡¶æ»¡æ—¶ï¼Œæ–°è¯·æ±‚ä¼šè¢«æ‹’ç»
- **æµé‡æ•´å½¢**ï¼šèƒ½å¤Ÿå°†çªå‘æµé‡è½¬æ¢ä¸ºå¹³ç¨³æµé‡

**é€‚ç”¨åœºæ™¯ï¼š**

- éœ€è¦ç¨³å®šè¾“å‡ºé€Ÿç‡çš„åœºæ™¯ï¼Œå¦‚æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹
- ä¿æŠ¤ä¸‹æ¸¸ç³»ç»Ÿä¸è¢«çªå‘æµé‡å†²å®
- éœ€è¦ä¸¥æ ¼æ§åˆ¶æµå‡ºé€Ÿç‡çš„APIæ¥å£





### 2ã€ä»£ç å®ç°

#### â‘ ã€è‡ªå®šä¹‰é˜²åˆ·æ³¨è§£

```java
/**
 * æ¼æ¡¶é™æµæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface LeakyBucketLimit {

    /**
     * é™æµkeyï¼Œæ”¯æŒSpELè¡¨è¾¾å¼
     */
    String key() default "";

    /**
     * æ¡¶çš„å®¹é‡ï¼ˆæœ€å¤§è¯·æ±‚æ•°ï¼‰
     */
    int capacity() default 100;

    /**
     * æµå‡ºé€Ÿç‡ï¼ˆæ¯ç§’å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ï¼‰
     */
    int rate() default 10;

}
```

#### â‘¡ã€Luaè„šæœ¬

```lua
-- æ¼æ¡¶é™æµç®—æ³• Lua è„šæœ¬

-- å‚æ•°è¯´æ˜ï¼š
-- KEYS[1]: é™æµçš„key
-- ARGV[1]: æ¡¶çš„å®¹é‡
-- ARGV[2]: æµå‡ºé€Ÿç‡ï¼ˆæ¯ç§’å¤„ç†æ•°ï¼‰
-- ARGV[3]: å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
-- ARGV[4]: æœ¬æ¬¡è¯·æ±‚æ•°é‡

local key = KEYS[1]
local capacity = tonumber(ARGV[1])
local rate = tonumber(ARGV[2])
local now = tonumber(ARGV[3])
local requestCount = tonumber(ARGV[4])

-- è·å–æ¡¶çš„å½“å‰çŠ¶æ€
local bucketInfo = redis.call('hmget', key, 'water', 'lastLeakTime')
local currentWater = 0
local lastLeakTime = now

-- å¦‚æœæ¡¶å­˜åœ¨ï¼Œè·å–å½“å‰æ°´é‡å’Œä¸Šæ¬¡æ¼æ°´æ—¶é—´
if bucketInfo[1] then
    currentWater = tonumber(bucketInfo[1])
end

if bucketInfo[2] then
    lastLeakTime = tonumber(bucketInfo[2])
end

-- è®¡ç®—ä»ä¸Šæ¬¡æ¼æ°´åˆ°ç°åœ¨çš„æ¼å‡ºé‡
local leakAmount = (now - lastLeakTime) * rate
if leakAmount > 0 then
    currentWater = math.max(0, currentWater - leakAmount)
    lastLeakTime = now
end

-- æ£€æŸ¥æ¡¶æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´å®¹çº³æ–°è¯·æ±‚
if currentWater + requestCount <= capacity then
    -- å…è®¸è¯·æ±‚ï¼Œæ›´æ–°æ¡¶çŠ¶æ€
    currentWater = currentWater + requestCount
    redis.call('hmset', key, 'water', currentWater, 'lastLeakTime', lastLeakTime)
    redis.call('expire', key, 3600)  -- è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
    return 1  -- å…è®¸è®¿é—®
else
    -- æ¡¶å·²æ»¡ï¼Œæ‹’ç»è¯·æ±‚
    return 0  -- è¢«é™æµ
end
```

#### â‘¢ã€Luaè„šæœ¬é…ç½®

```java
/**
 * æ¼æ¡¶é™æµ Lua è„šæœ¬
 */
@Bean
public RedisScript<Long> leakyBucketScript() {
    DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
    redisScript.setLocation(leakyLuaFile);
    redisScript.setResultType(Long.class);
    return redisScript;
}
```

#### â‘£ã€æ¼æ¡¶é™æµæœåŠ¡ç±»

```java
@Slf4j
@Service
public class LeakyBucketRateLimiter {


    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    @Autowired
    private RedisScript<Long> leakyBucketScript;

    /**
     * å°è¯•è·å–é€šè¡Œè¯
     * @param key é™æµkey
     * @param capacity æ¡¶å®¹é‡
     * @param rate æµå‡ºé€Ÿç‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
     * @param requestCount è¯·æ±‚æ•°é‡
     * @return true-å…è®¸è®¿é—®ï¼Œfalse-è¢«é™æµ
     */
    public boolean tryAcquire(String key, int capacity, int rate, int requestCount) {
        long now = System.currentTimeMillis() / 1000; // ä½¿ç”¨ç§’çº§æ—¶é—´æˆ³

        Long result = redisTemplate.execute(leakyBucketScript,
                Collections.singletonList(key),
                capacity,rate,now,requestCount);

        return result != null && result == 1;
    }

}
```

#### â‘¤ã€æ¼æ¡¶é™æµåˆ‡ç‰‡æ ¸å¿ƒé€»è¾‘

```java
@Slf4j
@Aspect
@Component
public class LeakyBucketLimitAspect {

    @Autowired
    private LeakyBucketRateLimiter rateLimiter;

    @Around("@annotation(leakyBucketLimit)")
    public Object around(ProceedingJoinPoint joinPoint, LeakyBucketLimit leakyBucketLimit) throws Throwable {
        String key = buildRateLimitKey(joinPoint, leakyBucketLimit);
        int capacity = leakyBucketLimit.capacity();
        int rate = leakyBucketLimit.rate();

        LeakyBucketRateLimiter.BucketStatus bucketStatus = rateLimiter.getBucketStatus(key);
        log.debug("bucket status: key={}, water={},lastLeakTime={},ttl={}",key,
                bucketStatus.getCurrentWater(), bucketStatus.getLastLeakTime(), bucketStatus.getTtl());
        if (!rateLimiter.tryAcquire(key, capacity, rate, 1)) {
            throw new ApiException(ApiResultEnum.REQUEST_LIMIT);
        }

        return joinPoint.proceed();
    }

    /**
     * æ„å»ºé™æµkey
     */
    private String buildRateLimitKey(ProceedingJoinPoint joinPoint, LeakyBucketLimit rateLimit) {
        String key = rateLimit.key();

        // å¦‚æœkeyä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
        if (key.isEmpty()) {
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            String className = method.getDeclaringClass().getSimpleName();
            String methodName = method.getName();

            // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯
            String userKey = getCurrentUserId();
            return String.format("leaky_bucket:%s:%s:%s", className, methodName, userKey);
        }

        // å¦‚æœkeyåŒ…å«SpELè¡¨è¾¾å¼ï¼Œè¿›è¡Œè§£æ
        if (key.contains("#")) {
            return AopUtil.parseSpel(key, joinPoint);
        }
        return key;
    }

    private String getCurrentUserId() {
        // å®é™…é¡¹ç›®ä¸­ä»å®‰å…¨ä¸Šä¸‹æ–‡è·å–
        return "user123";
    }
}
```

#### â‘¥ã€controllerç¤ºä¾‹

```java
@RestController
@RequestMapping("/leakyRate")
public class LeakyRateController {

    @Autowired
    private LeakyBucketRateLimiter leakyBucketRateLimiter;


    /**
     * æµ‹è¯•
     */
    @GetMapping("/test1")
    @LeakyBucketLimit(rate = 1, capacity = 3)
    public R test1() {
        //TODO ...
        return R.ok();
    }

    @GetMapping("/test2")
    @LeakyBucketLimit(key = "leaky_rate:test2",rate = 2, capacity = 1)
    public R test2() {
        //TODO ...
        return R.ok();
    }

    @LeakyBucketLimit(key = "'user  :' + #username", rate = 2, capacity = 10)
    @GetMapping("/search")
    public R search(@RequestParam String username) {
        // æœç´¢é€»è¾‘ - è¿™é‡Œkeyä¼šæ ¹æ®usernameåŠ¨æ€å˜åŒ–
        return R.ok("username:" + username);
    }

}
```

## äºŒã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµ

### 1ã€ä»€ä¹ˆæ˜¯æ»‘åŠ¨æ—¶é—´çª—å£é™æµ



æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•å°†æ—¶é—´çº¿åˆ’åˆ†ä¸ºå¤šä¸ªå°çš„æ—¶é—´ç‰‡æ®µï¼Œé€šè¿‡æ»‘åŠ¨çª—å£çš„æ–¹å¼ç»Ÿè®¡æœ€è¿‘ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ¬¡æ•°ã€‚ç›¸æ¯”å›ºå®šçª—å£ï¼Œå®ƒèƒ½æ›´å¥½åœ°å¤„ç†æ—¶é—´è¾¹ç•Œé—®é¢˜ã€‚

**ç®—æ³•ä¼˜åŠ¿ï¼š**

- **å¹³æ»‘è¿‡æ¸¡**ï¼šè§£å†³äº†å›ºå®šçª—å£åœ¨è¾¹ç•Œæ—¶é—´çš„çªå‘é—®é¢˜
- **ç²¾å‡†æ§åˆ¶**ï¼šç²¾ç¡®ç»Ÿè®¡æ¯ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°
- **çµæ´»é…ç½®**ï¼šæ”¯æŒä»»æ„æ—¶é—´çª—å£å¤§å°



**é€‚ç”¨åœºæ™¯ï¼š**

- APIè°ƒç”¨é¢‘ç‡é™åˆ¶
- ç”¨æˆ·è¡Œä¸ºé¢‘ç‡æ§åˆ¶
- éœ€è¦ç²¾ç¡®æ—¶é—´æ§åˆ¶çš„é™æµåœºæ™¯



### 2ã€ä»£ç å®ç°

#### â‘ ã€è‡ªå®šä¹‰é˜²åˆ·æ³¨è§£

```java
/**
 * æ»‘åŠ¨æ—¶é—´çª—å£è®¡æ•°å™¨é™æµæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface SlidingWindowLimit {

    /**
     * é™æµkeyï¼Œæ”¯æŒSpELè¡¨è¾¾å¼
     */
    String key() default "";

    /**
     * æ—¶é—´çª—å£å¤§å°ï¼ˆç§’ï¼‰
     */
    int window() default 60;

    /**
     * æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
     */
    int maxCount() default 100;

}
```

#### â‘¡ã€Luaè„šæœ¬

```lua
-- æ»‘åŠ¨æ—¶é—´çª—å£è®¡æ•°å™¨é™æµç®—æ³•

-- å‚æ•°è¯´æ˜ï¼š
-- KEYS[1]: é™æµçš„key
-- ARGV[1]: æ—¶é—´çª—å£å¤§å°ï¼ˆç§’ï¼‰
-- ARGV[2]: æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
-- ARGV[3]: å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
-- ARGV[4]: æœ¬æ¬¡è¯·æ±‚æ•°é‡ï¼ˆé»˜è®¤ä¸º1ï¼‰

local key = KEYS[1]
local window = tonumber(ARGV[1])
local maxCount = tonumber(ARGV[2])
local now = tonumber(ARGV[3])
local requestCount = tonumber(ARGV[4]) or 1

-- è®¡ç®—æ—¶é—´çª—å£çš„èµ·å§‹æ—¶é—´æˆ³
local windowStart = now - window

-- ç§»é™¤æ—¶é—´çª—å£ä¹‹å‰çš„æ•°æ®
redis.call('zremrangebyscore', key, 0, windowStart)

-- è·å–å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ€»æ•°
local currentCount = redis.call('zcard', key)

-- æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
if currentCount + requestCount <= maxCount then
    -- æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼Œæ·»åŠ å½“å‰è¯·æ±‚
    for i = 1, requestCount do
        -- ä½¿ç”¨æ¯«ç§’çº§æ—¶é—´æˆ³+éšæœºæ•°ç¡®ä¿æˆå‘˜å”¯ä¸€æ€§
        local member = now * 1000 + math.random(0, 999)
        redis.call('zadd', key, member, member)
    end

    -- è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ä¸ºçª—å£å¤§å°+1ç§’ï¼Œç¡®ä¿æ•°æ®è‡ªåŠ¨æ¸…ç†
    redis.call('expire', key, window + 1)

    return 1  -- å…è®¸è®¿é—®
else
    -- è¶…è¿‡é™åˆ¶ï¼Œæ‹’ç»è¯·æ±‚
    return 0  -- è¢«é™æµ
end
```
#### â‘¢ã€Luaè„šæœ¬é…ç½®

```java
/**
 * æ»‘åŠ¨æ—¶é—´çª—å£è®¡æ•°å™¨é™æµ Lua è„šæœ¬
 */
@Bean
public RedisScript<Long> slidingWindowScript() {
    DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
    redisScript.setLocation(slidingWindowLuaFile);
    redisScript.setResultType(Long.class);
    return redisScript;
}
```

#### â‘£ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµæœåŠ¡ç±»

```java
@Slf4j
@Service
public class SlidingWindowRateLimiter {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    @Autowired
    private RedisScript<Long> slidingWindowScript;

    /**
     * å°è¯•è·å–é€šè¡Œè¯
     * @param key é™æµkey
     * @param window æ—¶é—´çª—å£å¤§å°ï¼ˆç§’ï¼‰
     * @param maxCount æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
     * @param requestCount è¯·æ±‚æ•°é‡
     * @return true-å…è®¸è®¿é—®ï¼Œfalse-è¢«é™æµ
     */
    public boolean tryAcquire(String key, int window, int maxCount, int requestCount) {
        long now = System.currentTimeMillis() / 1000; // ä½¿ç”¨ç§’çº§æ—¶é—´æˆ³
        Long result = redisTemplate.execute(slidingWindowScript,
                Collections.singletonList(key), window, maxCount, now, requestCount);

        return result != null && result == 1;
    }

}
```

#### â‘¤ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµåˆ‡ç‰‡æ ¸å¿ƒé€»è¾‘

```java
@Slf4j
@Aspect
@Component
public class SlidingWindowLimitAspect {

    private final SlidingWindowRateLimiter rateLimiter;

    public SlidingWindowLimitAspect(SlidingWindowRateLimiter rateLimiter) {
        this.rateLimiter = rateLimiter;
    }

    @Around("@annotation(slidingWindowLimit)")
    public Object around(ProceedingJoinPoint joinPoint, SlidingWindowLimit slidingWindowLimit) throws Throwable {
        String key = buildRateLimitKey(joinPoint, slidingWindowLimit);
        int window = slidingWindowLimit.window();
        int maxCount = slidingWindowLimit.maxCount();

        if (!rateLimiter.tryAcquire(key, window, maxCount, 1)) {
            throw new ApiException(ApiResultEnum.REQUEST_LIMIT);
        }

        return joinPoint.proceed();
    }

    /**
     * æ„å»ºé™æµkey
     */
    private String buildRateLimitKey(ProceedingJoinPoint joinPoint, SlidingWindowLimit rateLimit) {
        String key = rateLimit.key();

        // å¦‚æœkeyä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
        if (key.isEmpty()) {
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            String className = method.getDeclaringClass().getSimpleName();
            String methodName = method.getName();

            // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯
            String userKey = getCurrentUserId();
            return String.format("sliding_window:%s:%s:%s", className, methodName, userKey);
        }

        // å¦‚æœkeyåŒ…å«SpELè¡¨è¾¾å¼ï¼Œè¿›è¡Œè§£æ
        if (key.contains("#")) {
            return AopUtil.parseSpel(key, joinPoint);
        }
        return key;
    }

    private String getCurrentUserId() {
        // å®é™…é¡¹ç›®ä¸­ä»å®‰å…¨ä¸Šä¸‹æ–‡è·å–
        return "user123";
    }
}
```

#### â‘¥ã€controllerç¤ºä¾‹

```java
@RestController
@RequestMapping("/SlidingWindowRate")
public class SlidingWindowRateController {

    @Autowired
    private SlidingWindowRateLimiter slidingWindowRateLimiter;

    /**
     * æµ‹è¯•
     */
    @GetMapping("/test1")
    @SlidingWindowLimit(window = 3, maxCount = 1)
    public R test1() {
        //TODO ...
        return R.ok();
    }

    @GetMapping("/test2")
    @SlidingWindowLimit(key = "sliding_window:test2",window = 60, maxCount = 5)
    public R test2() {
        //TODO ...
        return R.ok();
    }

    @SlidingWindowLimit(key = "'user  :' + #username")
    @GetMapping("/search")
    public R search(@RequestParam String username) {
        // æœç´¢é€»è¾‘ - è¿™é‡Œkeyä¼šæ ¹æ®usernameåŠ¨æ€å˜åŒ–
        return R.ok("username:" + username);
    }

}
```



![rediså­˜å‚¨KEYçš„ç¤ºä¾‹å›¾](limit.png)





## ä¸‰ã€æ€»ç»“



### é™æµç®—æ³•é€‰æ‹©æŒ‡å—

| ç®—æ³•ç±»å‹     | é€‚ç”¨åœºæ™¯                       | ä¼˜ç‚¹                   | ç¼ºç‚¹                       |
| :----------- | :----------------------------- | :--------------------- | :------------------------- |
| **æ¼æ¡¶é™æµ** | éœ€è¦ç¨³å®šè¾“å‡ºé€Ÿç‡ã€ä¿æŠ¤ä¸‹æ¸¸ç³»ç»Ÿ | è¾“å‡ºç¨³å®šã€å¹³æ»‘æµé‡     | æ— æ³•åº”å¯¹çªå‘æµé‡ã€å“åº”å»¶è¿Ÿ |
| **æ»‘åŠ¨çª—å£** | ç²¾ç¡®æ§åˆ¶æ—¶é—´æ®µå†…çš„è¯·æ±‚æ¬¡æ•°     | è¾¹ç•Œå¤„ç†ä¼˜ç§€ã€ç²¾ç¡®æ§åˆ¶ | å®ç°ç›¸å¯¹å¤æ‚ã€å†…å­˜å ç”¨è¾ƒå¤š |
| **ä»¤ç‰Œæ¡¶**   | å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘æµé‡         | æ”¯æŒçªå‘æµé‡ã€çµæ´»æ€§é«˜ | å¯èƒ½ç¬é—´æ‰“æ»¡ç³»ç»Ÿ           |
| **å›ºå®šçª—å£** | ç®€å•è®¡æ•°åœºæ™¯ã€å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜   | å®ç°ç®€å•ã€æ€§èƒ½é«˜       | è¾¹ç•Œæ—¶é—´å¯èƒ½è¶…é™           |





#### èµ„æºè·å–ï¼š

æœ¬æ–‡å®Œæ•´ä»£ç å·²ä¸Šä¼ è‡³ GitHubï¼Œæ¬¢è¿ Star â­ å’Œ Fork

- Giteeåœ°å€ï¼šhttps://gitee.com/rstyro/spring-boot/tree/master/SpringBoot-limit
- Githubåœ°å€ï¼šhttps://github.com/rstyro/Springboot/tree/master/SpringBoot-limit





**åŸåˆ›ä¸æ˜“ï¼Œå¦‚æœ‰æ”¶è·ï¼Œè¯·ç‚¹èµæ”¶è—æ”¯æŒï¼** ğŸ”¥

